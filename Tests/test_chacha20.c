#include "chacha20.h"

#include <string.h>

#include "unity.h"
#include "unity_fixture.h"

TEST_GROUP(Chacha20);

TEST_SETUP(Chacha20) {
}

TEST_TEAR_DOWN(Chacha20) {
}

TEST_GROUP_RUNNER(Chacha20) {
    RUN_TEST_CASE(Chacha20, Chacha20_crypt_01);
    RUN_TEST_CASE(Chacha20, Chacha20_crypt_02);
    RUN_TEST_CASE(Chacha20, Chacha20_crypt_03);
    RUN_TEST_CASE(Chacha20, Chacha20_crypt_04);
}

TEST(Chacha20, Chacha20_crypt_01) {

    byte_t key[CHACHA20_KEY_SIZE] = {
        0x00U, 0x01U, 0x02U, 0x03U, 0x04U, 0x05U, 0x06U, 0x07U, 0x08U, 0x09U, 0x0aU, 0x0bU, 0x0cU, 0x0dU, 0x0eU, 0x0fU,
        0x10U, 0x11U, 0x12U, 0x13U, 0x14U, 0x15U, 0x16U, 0x17U, 0x18U, 0x19U, 0x1aU, 0x1bU, 0x1cU, 0x1dU, 0x1eU, 0x1fU
    };
    byte_t nonce[CHACHA20_NONCE_SIZE] = {
        0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x4aU, 0x00U, 0x00U, 0x00U, 0x00U
    };
    byte_t plaintext[] =
        "Ladies and Gentlemen of the class of '99: If I could offer you only one tip for the future, sunscreen would be it.";

    uint32_t initial_block_counter = 1U;

    byte_t result[sizeof(plaintext)] = {0x00U};

    byte_t expected_encrypted_msg[] = {
        0x6eU, 0x2eU, 0x35U, 0x9aU, 0x25U, 0x68U, 0xf9U, 0x80U, 0x41U, 0xbaU, 0x07U, 0x28U, 0xddU, 0x0dU, 0x69U, 0x81U,
        0xe9U, 0x7eU, 0x7aU, 0xecU, 0x1dU, 0x43U, 0x60U, 0xc2U, 0x0aU, 0x27U, 0xafU, 0xccU, 0xfdU, 0x9fU, 0xaeU, 0x0bU,
        0xf9U, 0x1bU, 0x65U, 0xc5U, 0x52U, 0x47U, 0x33U, 0xabU, 0x8fU, 0x59U, 0x3dU, 0xabU, 0xcdU, 0x62U, 0xb3U, 0x57U,
        0x16U, 0x39U, 0xd6U, 0x24U, 0xe6U, 0x51U, 0x52U, 0xabU, 0x8fU, 0x53U, 0x0cU, 0x35U, 0x9fU, 0x08U, 0x61U, 0xd8U,
        0x07U, 0xcaU, 0x0dU, 0xbfU, 0x50U, 0x0dU, 0x6aU, 0x61U, 0x56U, 0xa3U, 0x8eU, 0x08U, 0x8aU, 0x22U, 0xb6U, 0x5eU,
        0x52U, 0xbcU, 0x51U, 0x4dU, 0x16U, 0xccU, 0xf8U, 0x06U, 0x81U, 0x8cU, 0xe9U, 0x1aU, 0xb7U, 0x79U, 0x37U, 0x36U,
        0x5aU, 0xf9U, 0x0bU, 0xbfU, 0x74U, 0xa3U, 0x5bU, 0xe6U, 0xb4U, 0x0bU, 0x8eU, 0xedU, 0xf2U, 0x78U, 0x5eU, 0x42U,
        0x87U, 0x4dU
    };

    // Encryption
    Chacha20_crypt(plaintext, strlen((char*)plaintext), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(expected_encrypted_msg, result, sizeof(expected_encrypted_msg));

    // Decryption
    Chacha20_crypt(expected_encrypted_msg, sizeof(expected_encrypted_msg), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(plaintext, result, strlen((char*)plaintext));
}

TEST(Chacha20, Chacha20_crypt_02) {

    byte_t key[CHACHA20_KEY_SIZE] = {0x00U};
    byte_t nonce[CHACHA20_NONCE_SIZE] = {0x00U};
    byte_t plaintext[64] = {0x00U};
    uint32_t initial_block_counter = 0U;

    byte_t result[sizeof(plaintext)] = {0x00U};

    byte_t expected_encrypted_msg[] = {
        0x76U, 0xb8U, 0xe0U, 0xadU, 0xa0U, 0xf1U, 0x3dU, 0x90U, 0x40U, 0x5dU, 0x6aU, 0xe5U, 0x53U, 0x86U, 0xbdU, 0x28U,
        0xbdU, 0xd2U, 0x19U, 0xb8U, 0xa0U, 0x8dU, 0xedU, 0x1aU, 0xa8U, 0x36U, 0xefU, 0xccU, 0x8bU, 0x77U, 0x0dU, 0xc7U,
        0xdaU, 0x41U, 0x59U, 0x7cU, 0x51U, 0x57U, 0x48U, 0x8dU, 0x77U, 0x24U, 0xe0U, 0x3fU, 0xb8U, 0xd8U, 0x4aU, 0x37U,
        0x6aU, 0x43U, 0xb8U, 0xf4U, 0x15U, 0x18U, 0xa1U, 0x1cU, 0xc3U, 0x87U, 0xb6U, 0x69U, 0xb2U, 0xeeU, 0x65U, 0x86U
    };

    // Encryption
    Chacha20_crypt(plaintext, sizeof(plaintext), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(expected_encrypted_msg, result, sizeof(expected_encrypted_msg));

    // Decryption
    Chacha20_crypt(expected_encrypted_msg, sizeof(expected_encrypted_msg), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(plaintext, result, sizeof(plaintext));
}

TEST(Chacha20, Chacha20_crypt_03) {

    byte_t key[CHACHA20_KEY_SIZE] = {
        0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
        0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x01U
    };
    byte_t nonce[CHACHA20_NONCE_SIZE] = {
        0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x02U
    };
    byte_t plaintext[] = {
        "Any submission to the IETF intended by the Contributor for publication as all or part of an IETF Internet-Draft or RFC and any statement made within the context of an IETF activity is considered an \"IETF Contribution\". Such statements include oral statements in IETF sessions, as well as written and electronic communications made at any time or place, which are addressed to"
    };
    uint32_t initial_block_counter = 1U;

    byte_t result[sizeof(plaintext)] = {0x00U};

    byte_t expected_encrypted_msg[] = {
        0xa3U, 0xfbU, 0xf0U, 0x7dU, 0xf3U, 0xfaU, 0x2fU, 0xdeU, 0x4fU, 0x37U, 0x6cU, 0xa2U, 0x3eU, 0x82U, 0x73U, 0x70U,
        0x41U, 0x60U, 0x5dU, 0x9fU, 0x4fU, 0x4fU, 0x57U, 0xbdU, 0x8cU, 0xffU, 0x2cU, 0x1dU, 0x4bU, 0x79U, 0x55U, 0xecU,
        0x2aU, 0x97U, 0x94U, 0x8bU, 0xd3U, 0x72U, 0x29U, 0x15U, 0xc8U, 0xf3U, 0xd3U, 0x37U, 0xf7U, 0xd3U, 0x70U, 0x05U,
        0x0eU, 0x9eU, 0x96U, 0xd6U, 0x47U, 0xb7U, 0xc3U, 0x9fU, 0x56U, 0xe0U, 0x31U, 0xcaU, 0x5eU, 0xb6U, 0x25U, 0x0dU,
        0x40U, 0x42U, 0xe0U, 0x27U, 0x85U, 0xecU, 0xecU, 0xfaU, 0x4bU, 0x4bU, 0xb5U, 0xe8U, 0xeaU, 0xd0U, 0x44U, 0x0eU,
        0x20U, 0xb6U, 0xe8U, 0xdbU, 0x09U, 0xd8U, 0x81U, 0xa7U, 0xc6U, 0x13U, 0x2fU, 0x42U, 0x0eU, 0x52U, 0x79U, 0x50U,
        0x42U, 0xbdU, 0xfaU, 0x77U, 0x73U, 0xd8U, 0xa9U, 0x05U, 0x14U, 0x47U, 0xb3U, 0x29U, 0x1cU, 0xe1U, 0x41U, 0x1cU,
        0x68U, 0x04U, 0x65U, 0x55U, 0x2aU, 0xa6U, 0xc4U, 0x05U, 0xb7U, 0x76U, 0x4dU, 0x5eU, 0x87U, 0xbeU, 0xa8U, 0x5aU,
        0xd0U, 0x0fU, 0x84U, 0x49U, 0xedU, 0x8fU, 0x72U, 0xd0U, 0xd6U, 0x62U, 0xabU, 0x05U, 0x26U, 0x91U, 0xcaU, 0x66U,
        0x42U, 0x4bU, 0xc8U, 0x6dU, 0x2dU, 0xf8U, 0x0eU, 0xa4U, 0x1fU, 0x43U, 0xabU, 0xf9U, 0x37U, 0xd3U, 0x25U, 0x9dU,
        0xc4U, 0xb2U, 0xd0U, 0xdfU, 0xb4U, 0x8aU, 0x6cU, 0x91U, 0x39U, 0xddU, 0xd7U, 0xf7U, 0x69U, 0x66U, 0xe9U, 0x28U,
        0xe6U, 0x35U, 0x55U, 0x3bU, 0xa7U, 0x6cU, 0x5cU, 0x87U, 0x9dU, 0x7bU, 0x35U, 0xd4U, 0x9eU, 0xb2U, 0xe6U, 0x2bU,
        0x08U, 0x71U, 0xcdU, 0xacU, 0x63U, 0x89U, 0x39U, 0xe2U, 0x5eU, 0x8aU, 0x1eU, 0x0eU, 0xf9U, 0xd5U, 0x28U, 0x0fU,
        0xa8U, 0xcaU, 0x32U, 0x8bU, 0x35U, 0x1cU, 0x3cU, 0x76U, 0x59U, 0x89U, 0xcbU, 0xcfU, 0x3dU, 0xaaU, 0x8bU, 0x6cU,
        0xccU, 0x3aU, 0xafU, 0x9fU, 0x39U, 0x79U, 0xc9U, 0x2bU, 0x37U, 0x20U, 0xfcU, 0x88U, 0xdcU, 0x95U, 0xedU, 0x84U,
        0xa1U, 0xbeU, 0x05U, 0x9cU, 0x64U, 0x99U, 0xb9U, 0xfdU, 0xa2U, 0x36U, 0xe7U, 0xe8U, 0x18U, 0xb0U, 0x4bU, 0x0bU,
        0xc3U, 0x9cU, 0x1eU, 0x87U, 0x6bU, 0x19U, 0x3bU, 0xfeU, 0x55U, 0x69U, 0x75U, 0x3fU, 0x88U, 0x12U, 0x8cU, 0xc0U,
        0x8aU, 0xaaU, 0x9bU, 0x63U, 0xd1U, 0xa1U, 0x6fU, 0x80U, 0xefU, 0x25U, 0x54U, 0xd7U, 0x18U, 0x9cU, 0x41U, 0x1fU,
        0x58U, 0x69U, 0xcaU, 0x52U, 0xc5U, 0xb8U, 0x3fU, 0xa3U, 0x6fU, 0xf2U, 0x16U, 0xb9U, 0xc1U, 0xd3U, 0x00U, 0x62U,
        0xbeU, 0xbcU, 0xfdU, 0x2dU, 0xc5U, 0xbcU, 0xe0U, 0x91U, 0x19U, 0x34U, 0xfdU, 0xa7U, 0x9aU, 0x86U, 0xf6U, 0xe6U,
        0x98U, 0xceU, 0xd7U, 0x59U, 0xc3U, 0xffU, 0x9bU, 0x64U, 0x77U, 0x33U, 0x8fU, 0x3dU, 0xa4U, 0xf9U, 0xcdU, 0x85U,
        0x14U, 0xeaU, 0x99U, 0x82U, 0xccU, 0xafU, 0xb3U, 0x41U, 0xb2U, 0x38U, 0x4dU, 0xd9U, 0x02U, 0xf3U, 0xd1U, 0xabU,
        0x7aU, 0xc6U, 0x1dU, 0xd2U, 0x9cU, 0x6fU, 0x21U, 0xbaU, 0x5bU, 0x86U, 0x2fU, 0x37U, 0x30U, 0xe3U, 0x7cU, 0xfdU,
        0xc4U, 0xfdU, 0x80U, 0x6cU, 0x22U, 0xf2U, 0x21U
    };

    // Encryption
    Chacha20_crypt(plaintext, strlen((char*)plaintext), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(expected_encrypted_msg, result, sizeof(expected_encrypted_msg));

    // Decryption
    Chacha20_crypt(expected_encrypted_msg, sizeof(expected_encrypted_msg), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(plaintext, result, strlen((char*)plaintext));
}

TEST(Chacha20, Chacha20_crypt_04) {

    byte_t key[CHACHA20_KEY_SIZE] = {
        0x1cU, 0x92U, 0x40U, 0xa5U, 0xebU, 0x55U, 0xd3U, 0x8aU, 0xf3U, 0x33U, 0x88U, 0x86U, 0x04U, 0xf6U, 0xb5U, 0xf0U,
        0x47U, 0x39U, 0x17U, 0xc1U, 0x40U, 0x2bU, 0x80U, 0x09U, 0x9dU, 0xcaU, 0x5cU, 0xbcU, 0x20U, 0x70U, 0x75U, 0xc0U
    };
    byte_t nonce[CHACHA20_NONCE_SIZE] = {
        0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x02U
    };
    byte_t plaintext[] = {
        "'Twas brillig, and the slithy toves\nDid gyre and gimble in the wabe:\nAll mimsy were the borogoves,\nAnd the mome raths outgrabe."
    };
    uint32_t initial_block_counter = 42U;

    byte_t result[sizeof(plaintext)] = {0x00U};

    byte_t expected_encrypted_msg[] = {
        0x62U, 0xe6U, 0x34U, 0x7fU, 0x95U, 0xedU, 0x87U, 0xa4U, 0x5fU, 0xfaU, 0xe7U, 0x42U, 0x6fU, 0x27U, 0xa1U, 0xdfU,
        0x5fU, 0xb6U, 0x91U, 0x10U, 0x04U, 0x4cU, 0x0dU, 0x73U, 0x11U, 0x8eU, 0xffU, 0xa9U, 0x5bU, 0x01U, 0xe5U, 0xcfU,
        0x16U, 0x6dU, 0x3dU, 0xf2U, 0xd7U, 0x21U, 0xcaU, 0xf9U, 0xb2U, 0x1eU, 0x5fU, 0xb1U, 0x4cU, 0x61U, 0x68U, 0x71U,
        0xfdU, 0x84U, 0xc5U, 0x4fU, 0x9dU, 0x65U, 0xb2U, 0x83U, 0x19U, 0x6cU, 0x7fU, 0xe4U, 0xf6U, 0x05U, 0x53U, 0xebU,
        0xf3U, 0x9cU, 0x64U, 0x02U, 0xc4U, 0x22U, 0x34U, 0xe3U, 0x2aU, 0x35U, 0x6bU, 0x3eU, 0x76U, 0x43U, 0x12U, 0xa6U,
        0x1aU, 0x55U, 0x32U, 0x05U, 0x57U, 0x16U, 0xeaU, 0xd6U, 0x96U, 0x25U, 0x68U, 0xf8U, 0x7dU, 0x3fU, 0x3fU, 0x77U,
        0x04U, 0xc6U, 0xa8U, 0xd1U, 0xbcU, 0xd1U, 0xbfU, 0x4dU, 0x50U, 0xd6U, 0x15U, 0x4bU, 0x6dU, 0xa7U, 0x31U, 0xb1U,
        0x87U, 0xb5U, 0x8dU, 0xfdU, 0x72U, 0x8aU, 0xfaU, 0x36U, 0x75U, 0x7aU, 0x79U, 0x7aU, 0xc1U, 0x88U, 0xd1U
    };

    // Encryption
    Chacha20_crypt(plaintext, strlen((char*)plaintext), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(expected_encrypted_msg, result, sizeof(expected_encrypted_msg));

    // Decryption
    Chacha20_crypt(expected_encrypted_msg, sizeof(expected_encrypted_msg), key, nonce, initial_block_counter, result);
    TEST_ASSERT_EQUAL_MEMORY(plaintext, result, strlen((char*)plaintext));
}
